<!DOCTYPE html>
<html>
  <head>
	 <meta charset="utf-8">
	 <meta http-equiv="X-UA-Compatible" content="IE=edge">
	 <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  </head>

  <body style="margin: 20px;">
  <div class="container">
  <h1>Machine List</h1>
  <a href="/create" class="btn btn-warning btn-sm active" role="button">CREATE VIRTUALMACHINE</a>
  <a href="/add" class="btn btn-primary btn-sm active" role="button">ADD PHYSICALMACHINE</a>
  <input align="left" type="text" id="vm_filter" value=""></input>
  </div>
  <div id="display" class="container">
  </div>

  <script src="include/LAB.js" type="text/javascript"></script>

  <script id="host-begin" type="text/x-handlebars-template">
  <h3>{{Name}}({{IpAddress}})  {{Description}}</h3>
  <table class="table table-hover table-condensed" width="100%">
  <thead>
  <tr class=info> <th width="30%">Name</th> <th width="10%">Running</th> <th width="20%">Owner</th> <th width="30%">Description</th> <th width="10%">EDIT</th></tr>
  </thead>
  <tbody>
  </script>
  <script id="vms" type="text/x-handlebars-template">
  <tr>
  <td>
	{{#if Active}}
		<a href="/vnc_auto.html?title={{Name}}&path=websockify?ip={{VNCAddress}}:{{VNCPort}}" target="_blank">{{Name}}</a>
	{{else}}
		{{Name}}
	{{/if}}
  </td>
  <td>{{Active}}</td>
  <td>{{Owner}} </td>
  <td>{{Description}} </td>
  <td>
  	<a href="/vm/{{Id}}" class="btn btn-success btn-xs active" role="button">EDIT</a>
  </td>
  </tr>
  </script>

  <script id="host-end" type="text/x-handlebars-template">
  </tbody>
  </table>
  </script>
  
  <script type="text/javascript">
  	var gall = null;
  	function display(data)
	{
			if(null == data)
					return;
			var doc = document;
			var div = doc.getElementById("display");
			var html="";
			var hostshtml = $("#host-begin").html();
			var hosttemplate = Handlebars.compile(hostshtml);
			var vmshtml = $("#vms").html();
			var vmstemplate = Handlebars.compile(vmshtml);
			var endhtml = $("#host-end").html();
			var length = data.length;
			var vmfilter = doc.getElementById("vm_filter");
			var regstr = vmfilter.value;
			
			if("" == regstr || "*" == regstr){
					regstr = ".*";
			}

			var regarray = regstr.split("/");
			var regnum = regarray.length;
			var reghost = "";
			var regvmname = "";
			var regvmuser = "";
			switch(regnum)
			{
					case 1:
							regvmname = regstr;
							break;
					case 2:
							regvmname=regarray[0];
							regvmuser=regarray[1];
							break;
					case 3:
							reghost = regarray[0];
							regvmname = regarray[1];
							regvmuser = regarray[2];
							break;
					default:
							break;
			};
		
			if( "" == reghost ){
					reghost = ".*";
			}

			if( "" == regvmuser ){
					regvmuser = ".*";
			}

			var patt_host = new RegExp(reghost);
			var patt_vm_name = new RegExp(regvmname);
			var patt_vm_user = new RegExp(regvmuser);
			for(var i=0; i<length; i++)
			{
					if( ! patt_host.test(data[i].Name) )
							continue;
					html += hosttemplate(data[i]);
					var vms = data[i].VirtualMachines;
					var vmcount = vms.length;
					for(var j=0; j<vmcount; j++)
					{
							if( ! patt_vm_name.test(vms[j].Name) )
									continue;
							if( ! patt_vm_user.test(vms[j].Owner) )
									continue;
							html += vmstemplate(vms[j]);
					}
					html += endhtml;
			}
			div.innerHTML = html;
	}

	function setgall(data)
	{
			gall = data;
			display(data);
	}

	function query()
	{
	    if(null == gall)
		{
				var response = $.get("api/list");
				response.done(setgall);
				response.fail(function(){
						$("#sets").html("Failed to get vm lists.");
						});
		}
		else
		{
				display(gall);
		}
	}

  	function init()
	{
			query();
			$("#vm_filter").keyup(function(e){
							if(13 == e.keyCode)
							{
								query();
							}
						}
						);
	}
	$LAB.script("https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js")
	//.script("//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js")
	.script("http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v1.3.0.js").wait(function(){
					$(document).ready(init);
					});
  </script>
  </body>
  </html>
